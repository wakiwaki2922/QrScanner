# TÃªn cá»§a quy trÃ¬nh lÃ m viá»‡c, sáº½ hiá»ƒn thá»‹ trong tab "Actions" trÃªn GitHub
name: Build Executable

# Äiá»u kiá»‡n kÃ­ch hoáº¡t: cháº¡y quy trÃ¬nh nÃ y khi má»™t báº£n phÃ¡t hÃ nh (release) má»›i Ä‘Æ°á»£c táº¡o
on:
  release:
    types: [created]

# Cáº¥p quyá»n cho GITHUB_TOKEN
permissions:
  contents: write

# CÃ¡c cÃ´ng viá»‡c (jobs) cáº§n thá»±c hiá»‡n
jobs:
  build:
    # Cháº¡y trÃªn má»™t mÃ¡y áº£o Windows má»›i nháº¥t do GitHub cung cáº¥p
    runs-on: windows-latest

    steps:
      # BÆ°á»›c 1: Láº¥y mÃ£ nguá»“n tá»« repository vá» mÃ¡y áº£o
      - name: Checkout repository
        uses: actions/checkout@v4

      # BÆ°á»›c 2: CÃ i Ä‘áº·t Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.9' # Báº¡n cÃ³ thá»ƒ Ä‘á»•i phiÃªn báº£n Python náº¿u muá»‘n

      # BÆ°á»›c 3: CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n Python cáº§n thiáº¿t
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # BÆ°á»›c 4: Clean build Ä‘á»ƒ Ä‘áº£m báº£o fresh build
      - name: Clean previous builds
        run: |
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          if (Test-Path "__pycache__") { Remove-Item -Recurse -Force "__pycache__" }

      # BÆ°á»›c 5: Build á»©ng dá»¥ng vá»›i optimizations Ä‘á»ƒ giáº£m false positive
      - name: Build optimized executable with PyInstaller
        run: pyinstaller QRScanner.spec --clean

      # BÆ°á»›c 6: Verify build success
      - name: Verify build
        run: |
          if (Test-Path "./dist/QRScanner.exe") {
            Write-Host "âœ… Build successful!"
            $size = (Get-Item "./dist/QRScanner.exe").Length / 1MB
            Write-Host "ğŸ“¦ File size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Host "âŒ Build failed - executable not found!"
            exit 1
          }

      # BÆ°á»›c 7: Find and install Windows SDK for signing
      - name: Setup Windows SDK for signing
        run: |
          # Find SignTool.exe in Windows SDK
          $signToolPaths = @(
            "C:\Program Files (x86)\Windows Kits\10\bin\*\x64\signtool.exe",
            "C:\Program Files\Microsoft SDKs\Windows\*\bin\x64\signtool.exe"
          )
          
          $signTool = $null
          foreach ($path in $signToolPaths) {
            $found = Get-ChildItem $path -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              $signTool = $found.FullName
              break
            }
          }
          
          if ($signTool) {
            Write-Host "âœ… Found SignTool: $signTool"
            echo "SIGNTOOL_PATH=$signTool" >> $env:GITHUB_ENV
          } else {
            Write-Host "âš ï¸ SignTool not found - executable will be unsigned"
            echo "SIGNTOOL_PATH=" >> $env:GITHUB_ENV
          }

      # BÆ°á»›c 8: Create self-signed certificate and sign executable
      - name: Sign executable (reduces false positives)
        run: |
          if ($env:SIGNTOOL_PATH) {
            try {
              # Create self-signed certificate
              Write-Host "ğŸ” Creating self-signed certificate..."
              $cert = New-SelfSignedCertificate -Subject "CN=QR Scanner Pro Ltd" -Type CodeSigningCert -KeySpec KeyExchange -KeyLength 2048 -Provider "Microsoft Enhanced Cryptographic Provider v1.0" -CertStoreLocation "cert:\CurrentUser\My" -KeyUsage DigitalSignature,KeyEncipherment -TextExtension @('2.5.29.37={text}1.3.6.1.5.5.7.3.3')
              
              # Export certificate to PFX
              $password = ConvertTo-SecureString -String "GitHub2025" -Force -AsPlainText
              Export-PfxCertificate -Cert $cert -FilePath "GitHubCert.pfx" -Password $password
              
              # Sign the executable
              Write-Host "ğŸ–Šï¸ Signing executable..."
              & $env:SIGNTOOL_PATH sign /f GitHubCert.pfx /p GitHub2025 /fd SHA256 /tr http://timestamp.sectigo.com /td SHA256 /v "./dist/QRScanner.exe"
              
              if ($LASTEXITCODE -eq 0) {
                Write-Host "âœ… Executable signed successfully!"
                
                # Verify signature
                & $env:SIGNTOOL_PATH verify /pa /v "./dist/QRScanner.exe"
                echo "IS_SIGNED=true" >> $env:GITHUB_ENV
              } else {
                Write-Host "âš ï¸ Signing failed, but continuing with unsigned executable"
                echo "IS_SIGNED=false" >> $env:GITHUB_ENV
              }
            } catch {
              Write-Host "âš ï¸ Signing error: $($_.Exception.Message)"
              Write-Host "Continuing with unsigned executable"
              echo "IS_SIGNED=false" >> $env:GITHUB_ENV
            }
          } else {
            Write-Host "âš ï¸ SignTool not available - skipping signing"
            echo "IS_SIGNED=false" >> $env:GITHUB_ENV
          }

      # BÆ°á»›c 9: Create hash file for integrity verification
      - name: Generate checksums
        run: |
          $hash = Get-FileHash "./dist/QRScanner.exe" -Algorithm SHA256
          "$($hash.Hash)  QRScanner-${{ github.ref_name }}.exe" | Out-File -FilePath "./dist/checksums.txt" -Encoding UTF8
          Write-Host "ğŸ“‹ SHA256: $($hash.Hash)"

      # BÆ°á»›c 10: Upload files to release with enhanced metadata
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./dist/QRScanner.exe
            ./dist/checksums.txt
          name: QRScanner-${{ github.ref_name }}.exe
          body: |
            ## ğŸ” QR Scanner Pro v${{ github.ref_name }}
            
            ### âœ¨ TÃ­nh nÄƒng:
            - QuÃ©t QR code tá»« mÃ n hÃ¬nh
            - Copy káº¿t quáº£ tá»± Ä‘á»™ng vÃ o clipboard
            - Giao diá»‡n thÃ¢n thiá»‡n
            - KhÃ´ng cáº§n káº¿t ná»‘i internet
            
            ### ğŸ›¡ï¸ Báº£o máº­t:
            - âœ… Signed digitally Ä‘á»ƒ giáº£m false positive
            - âœ… Source code public vÃ  minh báº¡ch  
            - âœ… Chá»‰ sá»­ dá»¥ng thÆ° viá»‡n tin cáº­y
            - âœ… KhÃ´ng thu tháº­p dá»¯ liá»‡u cÃ¡ nhÃ¢n
            
            ### ğŸ“¦ ThÃ´ng tin file:
            - **File**: QRScanner-${{ github.ref_name }}.exe (~25MB)
            - **SHA256**: Xem file checksums.txt
            - **Signed**: ${{ env.IS_SIGNED == 'true' && 'Yes (Self-signed certificate)' || 'No (Unable to sign)' }}
            
            ### â— Antivirus False Positive
            Náº¿u antivirus bÃ¡o false positive:
            1. ÄÃ¢y lÃ  váº¥n Ä‘á» thÆ°á»ng gáº·p vá»›i PyInstaller
            2. File Ä‘Ã£ Ä‘Æ°á»£c signed Ä‘á»ƒ giáº£m thiá»ƒu
            3. Submit false positive report tá»›i antivirus vendor
            4. Hoáº·c táº£i source code vÃ  build locally
            
            ### ğŸ“ Há»— trá»£:
            - GitHub Issues: [BÃ¡o lá»—i táº¡i Ä‘Ã¢y](https://github.com/${{ github.repository }}/issues)
            - Source Code: [Xem mÃ£ nguá»“n](https://github.com/${{ github.repository }})
